[
  {
    "objectID": "posts/post-with-code/index.html",
    "href": "posts/post-with-code/index.html",
    "title": "Phylogenetic tree with a geographic map",
    "section": "",
    "text": "In a recent meeting, I was shown an impressive figure and asked if I could attempt to recreate it. It was an amazing graphic, one that immediately struck me as having been created in Python. Unfortunately, I am far more proficient in R than in Python, especially when it comes to producing publication-quality figures. So I went about spedning the next two weeks in seeing if it could be done in R.\nLets take a look at our opponent:\nA few things that I imidiately got down was the"
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html",
    "href": "posts/2025-08-29_tree-with-map/index.html",
    "title": "Phylogenetic tree with a geographic map",
    "section": "",
    "text": "In a recent meeting, I was shown an impressive figure and asked if I could attempt to recreate it for a project. It was an amazing graphic, one that immediately struck me as having been created in Python. Unfortunately, I am far more proficient in R than in Python, especially when it comes to producing publication-quality figures. So I went about spending the next two weeks in seeing if it could be done in R.\nLets take a look at our opponent, Figure 2 from the publication: Dudas et al., 2021 - ‚ÄúEmergence and spread of SARS-CoV-2 lineage B.1.620 with variant of concern-like mutations and deletions‚Äù. Im not really sure how copyrights work,so I am not going to include the image here, but I made a mock-up of what I want to achieve.\n\n\n\nTree with map projections ‚Äòmockup‚Äô. I plotted the tree, but did clip in the map and draw the lines in Inkspace to represent what I wanted to do here. This is not the final plot.\n\n\nWe have a circular maximum likelihood tree with projections onto a map of Europe. The tree‚Äôs tip points are colored according to country, with lines extending from each tip to an ‚Äúinner circle‚Äù, from which they continue outward to the corresponding geographic coordinates. I like the use of this inner circle, it prevent the connective lines from crossing directly across the tree, retaining the structure of the branches.\nThere are a few obvious problems that struck me as I set out on this endeavor, the first being that circular trees will have polar coordinates (originating from the tree root), and the map with have cartographic coordinates. While I have not really considered the two together before, it seems obvious that they would not mix well.\nThe first thing I did was check to see if this publication has any code available, and they did. The authors of this really neat paper detailed their analysis extremely well and can be found on their GitHub page.\nIt appears that following is going on in this code:\n\nLoad SARS-CoV-2 tree and associated metadata, including sequence information, locations, travel data, and color schemes.\nCollapse trivial branches to simplify the tree and select a specific subtree of interest.\nScale branch lengths by the genome alignment length.\nSort branches geographically or by predefined country order to improve visualization.\nDeduplicate closely related tips from the same location to reduce tree complexity.\nPlot the phylogenetic tree in polar (circular) coordinates, including angle calculations, normalization of branch heights, scale bar with ticks and labels, computation of polar coordinates for nodes, curved internal branches, and tip plotting.\nAdd branches to the plot using line collections to render the tree structure.\nOverlay the tree onto a geographic map using a cartopy projection.\nHighlight tips representing travelers and geographically significant locations with larger markers, outer circles, and colors reflecting country or travel status.\nAdd a legend for selected countries and finalize the plot by removing ticks, labels, and spines, ensuring proper aspect ratio and layout.\n\nIm sure it‚Äôll be ten nice and easy steps.\n\nü§î Why not use phytools?? (which is accompanied by a very well maintained blog). This was a viable option, but I have two minor gripes, (i) the plots are not the most aesthetically pleasing ones (very shallow, I know), and (ii) I could not seem to achieve a circular tree with map projections."
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "This blog will be an occasional exploration of data analysis and graphics‚Äîshowcasing figures I‚Äôve created that I found interesting and that might inspire others."
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#preparing-some-test-data",
    "href": "posts/2025-08-29_tree-with-map/index.html#preparing-some-test-data",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Preparing some test data",
    "text": "Preparing some test data\n\nPhylogenetic tree\nCreating a test phylogenetic tree is easily achieved as such using ggtree, for which the resources are avaialble here.\n\n# echo: true\n# eval: true\n# warning: false\n# load library\nlibrary(ggtree)\n\nggtree v3.16.3 Learn more at https://yulab-smu.top/contribution-tree-data/\n\nPlease cite:\n\nGuangchuang Yu, Tommy Tsan-Yuk Lam, Huachen Zhu, Yi Guan. Two methods\nfor mapping and visualizing associated data on phylogeny using ggtree.\nMolecular Biology and Evolution. 2018, 35(12):3041-3043.\ndoi:10.1093/molbev/msy194\n\n# set random seed\nset.seed(1234)\n\n# create a test tree and plot\ntree &lt;- rtree(50)\ntree_p &lt;- ggtree(tree) + \n    layout_inward_circular(xlim=15)\n\nScale for y is already present.\nAdding another scale for y, which will replace the existing scale.\n\ntree_p"
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#preparing-test-data",
    "href": "posts/2025-08-29_tree-with-map/index.html#preparing-test-data",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Preparing test data",
    "text": "Preparing test data\n\nPhylogenetic tree\nCreating a test phylogenetic tree is easily achieved as such using ggtree, for which the resources are avaialble here.\n\n# create a test tree and plot\ntree &lt;- rtree(50)\ntree_p &lt;- ggtree(tree) + \n    layout_inward_circular(xlim=15) +\n    geom_tippoint(color = \"black\", size = 3) +\n    theme_minimal()\ntree_p\n\n\n\n\n\n\n\n\nFinally, in a real phylogeny, I would have meaningful data (taxonomy, host, patient, ect), so for this I can going to create some clusters. This probably would not make biological sense, but this is just purely for demonstration.\n\n# Pick some nodes to define clusters (here randomly picking nodes)\nnodes_to_group &lt;- sample((Ntip(tree)+1):(Ntip(tree)+Nnode(tree)), 5)\n\n# Create ggtree plot\ntree_p &lt;- ggtree(tree) + layout_inward_circular(xlim = 15)\n\n# Group clades\ntree_p &lt;- groupClade(tree_p, .node = nodes_to_group)\n\n# Color tip points based on group\ntree_p &lt;- tree_p + \n    geom_tippoint(\n        aes(color = group), \n        size = 3) +\n    scale_color_colorblind() +\n    theme_minimal() \ntree_p\n\n\n\n\n\n\n\n\nNext lets get the tip identities from this test data, we will need this later to assign random locations (longetude, latitude coordinates) to these tips.\n\ntree_data &lt;- tree_p$data |&gt; \n    dplyr::filter(isTip)\n\n# collect the tips\ntips &lt;- tree_data$label"
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#the-map",
    "href": "posts/2025-08-29_tree-with-map/index.html#the-map",
    "title": "Phylogenetic tree with a geographic map",
    "section": "The map",
    "text": "The map\nIn this example I am just going to get a shape file from the Spanish governments website Centro de Descargas. You may have to dig through the internet to find the correct shape files, but I have found success in government websites. For instance, this URL will redirect you to a zipped shape file containing Europe boundaries. The type of file you are looking for is a .shp file, or a shape file. These can be used to plot maps with the package sf. Additionally, they can be converted easily into shaped for plotting natively with ggplot.\nThankfull, we can download and unzip the file with R:\n\n# Download the shapefile. (note that I store it in a folder called 'data/'. You have to change that if needed.)\ndownload.file(\"https://centrodedescargas.cnig.es/CentroDescargas/limites-municipales-provinciales-autonomicos#/lineas_limite.zip\", destfile = \"data/lineas_limite.zip\")\n\n# If the above doesnt work, go to this link and download the data manually: https://centrodedescargas.cnig.es/CentroDescargas/limites-municipales-provinciales-autonomicos#\n## the code can be deposited in the working directory\n\n# Unzip this file. You can do it with R (as below), or clicking on the object you downloaded.\nunzip(\"data/lineas_limite.zip\", exdir = \"data\", junkpaths = FALSE)\n\nI stole that little chunk of code from R Graph Gallery, with a minor modification.\nWith the shape files downloaded, we can now import and draw out first map.\n\n# Import the shape file\nmap_sf &lt;- st_read(\"data/SHP_ETRS89/recintos_autonomicas_inspire_peninbal_etrs89/recintos_autonomicas_inspire_peninbal_etrs89.shp\")\n\nReading layer `recintos_autonomicas_inspire_peninbal_etrs89' from data source \n  `/home/phesketh/Documents/GitHub/pjhesbest.github.io/blog/posts/2025-08-29_tree-with-map/data/SHP_ETRS89/recintos_autonomicas_inspire_peninbal_etrs89/recintos_autonomicas_inspire_peninbal_etrs89.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 19 features and 9 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -9.301516 ymin: 35.17045 xmax: 4.327785 ymax: 43.79238\nGeodetic CRS:  ETRS89\n\n# Plot simple map\nggplot(map_sf) +\n    geom_sf(\n        fill = \"#a1c4bc\", \n        color = \"white\") +\n    theme_minimal()\n\n\n\n\n\n\n\n\nNice and easy so far. Next I create some test data for random locations.\n\n# Generate ~95% random uniform points across the geometry\nn_total &lt;- 50\n\nrandom_points &lt;- st_sample(map_sf, size = n_total, type = \"random\")\n\n# Plot the map with data points\nggplot(map_sf) +\n    geom_sf(fill = \"#a1c4bc\", color = \"white\") +\n    geom_sf(data = random_points, color = \"black\", size = 4) +\n    theme_minimal()\n\n\n\n\n\n\n\n\nFinally, I need to asign these geographic data points to the tips names. Because these are randomly shuffled, this will not be a meaningful plot, but this is just a test. In the real world, I would be importing data (tree, map and associated metadata for each tip/sample).\n\n# Suppose random_points is the sfc_POINT from st_sample()\nrandom_points_sf &lt;- st_sf(geometry = random_points)  # now it's an sf object\n\n# Add tip names\ntip_names_shuffled &lt;- sample(tree_data$label, size = length(random_points_sf$geometry))\nrandom_points_sf$label &lt;- tip_names_shuffled\n\n# Sort both by label\nrandom_points_sf &lt;- random_points_sf %&gt;%\n    arrange(label) \n\ntree_data_sorted &lt;- tree_data %&gt;%\n    arrange(label)\n\n# Add group column directly\nrandom_points_sf$group &lt;- tree_data_sorted$group\n\n# Replot the map coloring the datapoints by group\nmap &lt;- ggplot(map_sf) +\n    geom_sf(fill = \"#a1c4bc\", color = \"white\") +\n    geom_sf(data = random_points_sf, \n        aes(color = group), size = 4) +\n    theme_minimal() +\n    scale_color_colorblind() # nice colors\nmap"
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#final-thoughts",
    "href": "posts/2025-08-29_tree-with-map/index.html#final-thoughts",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Final thoughts",
    "text": "Final thoughts\nSo. I would not say that is is as elegant as the tree presented in the original publication, but I enjoyed to experience of recreating this graphic and hope that this is of some use to anyone."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "BASHing my head with code",
    "section": "",
    "text": "Phylogenetic tree with a geographic map\n\n\n\n\n\n\ncode\n\n\nanalysis\n\n\nphylogeny\n\n\nR\n\n\nggtree\n\n\n\n\n\n\n\n\n\nAug 29, 2025\n\n\nPoppy J Hesketh Best\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#bringing-it-all-together",
    "href": "posts/2025-08-29_tree-with-map/index.html#bringing-it-all-together",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Bringing it all together",
    "text": "Bringing it all together\n\nmap + tree_p\n\n\n\n\n\n\n\n\n\nTest One\nSo here are the map and the tree together. Now in the original python code from the article, the authors actually deconstructed the phylogenetic tree and replotted it in catesian space, since as you can see the plot is currently has polar coordinates. So each branch, and each node and tip coodinate needs to be recalcualted, the line drawn between the data. This is complex to acheive, and I did have a go at it."
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#bringing-it-all-together-wip",
    "href": "posts/2025-08-29_tree-with-map/index.html#bringing-it-all-together-wip",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Bringing it all together (WIP)",
    "text": "Bringing it all together (WIP)\n\nmap + tree_p\n\n\n\n\n\n\n\n\n\nTest One\nSo here are the map and the tree together. In the original python code from the article, the authors actually deconstructed the phylogenetic tree and replotted it in catesian space, since as you can see the plot is currently has polar coordinates. So each branch, and each node and tip coodinate needs to be recalcualted, the line drawn between the data. This is complex to acheive, and I did have a go at it."
  },
  {
    "objectID": "posts/2025-08-29_tree-with-map/index.html#preparing-r-environment",
    "href": "posts/2025-08-29_tree-with-map/index.html#preparing-r-environment",
    "title": "Phylogenetic tree with a geographic map",
    "section": "Preparing R environment",
    "text": "Preparing R environment\n\n# load library\nlibrary(ggtree)\nlibrary(dplyr)\nlibrary(ggthemes)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(ape)\n\n# set random seed\nset.seed(1234)"
  }
]