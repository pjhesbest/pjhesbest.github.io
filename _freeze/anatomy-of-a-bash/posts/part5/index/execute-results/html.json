{
  "hash": "eed367b2fc507ef3bed7255607af3073",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Part 5: Writing smarter scripts.\"\nauthor: \"Poppy J Hesketh Best\"\ndate: \"2025-08-28\"\ncategories: [code, analysis, beginners, \"Anatomy of a BASH\", \"Guide\"]\nimage: \"profile.png\"\nexecute:\n  echo: true\n  eval: false\n  engine: knitr\n---\n\nHere we cover how you can make your script stop/not run if the outout file already exists, or how to force it to overwrite the outputs.\n\n**[Part 2]() ⋘ Part 3 ⋙ [Part 4]()**\n\n---\n\n## Not running the script if the output of the tool already exists:\n\nIn the example [bin/tb-profiler_v1.sh](URL) you can see that there is an example to search a collated output from previous runs of this scrip before deciing to run the script or not. It uses an `if` statement to determine wether that particular sampleID exists the output, and if it does not (i.e. ) to run the script. But if the output does exists (i.e. ), the it skips that particuler sample.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n\n```\n:::\n\n\n## Forcing the script to run even if the output exists:\nIn a more sophisticated version of the script [bin/tb-profiler_v2.sh](URL) there is an additional flag to force the script to overright the previous output (i.e. ) using a flag of `-F`.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n\n```\n:::\n\n\n## Adding a counter if processing multiple samples\nIf a single process is quick and not computationaly demanding, then loops are a good way to parse through lots of samples at once. I like to add a counter, so that I can keep track of where the script is at when I send it to a HPC.\n\nTo add a counter, you first must set the counter at one: `COUNTER=1`, then you will want to get the total number of samples to be processed: `TOTAL=$(ls ${DIRECTORY}/*R1.fastq.gz | wc -l)`. With those now defined you can start the loop. In this example the loop is utilising the path `${DIRECTORY}` and searching for files containing the suffix `\\*_R1.fastq.gz`. This is done to capture the sample ID by using `basename` to remove the path and suffic of the R1 file.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nCOUNTER=0\nTOTAL=$(ls ${DIRECTORY}/*R1.fastq.gz | wc -l); COUNTER=1\nfor file in ${DIRECTORY}/*R1.fastq.gz; do\n···\n```\n:::\n\nWith the loop open, we can calculate the remaining number of samples to process: `REMAINING=$((TOTAL - COUNTER))`. Its important to know that shell can only perform simple mathematics, so bear this in mind when using its calculator functions. Then an `echo -e` is used to report which sample number the loop is on, and how many are remaining: \n\n\n::: {.cell}\n\n```{.bash .cell-code}\n···\necho -e \"   Sample: ${ID}  [${COUNTER}/${TOTAL}; ${REMAINING} remaining]\n                R1: ${DIRECTORY}/${ID}_R1.fastq.gz\n                R2: ${DIRECTORY}/${ID}_R2.fastq.gz\"\n···\n```\n:::\n\n\nIn this example a tool called TB-Profiler is running on the R1 and R2 FASTQ files, utilising the `\\${ID}` variable defined at the start of the loop for each sample. With the main function defined, we have to remember to increase the counter by 1, so that it increases with the loop to the next file: `COUNTER=$((COUNTER + 1))`. \n\nIn all this might look something like this:\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nCOUNTER=1 # start the counter\nTOTAL=$(ls ${DIRECTORY}/*R1.fastq.gz | wc -l) # get the total\n\nfor file in ${DIRECTORY}/*R1.fastq.gz; do\n    ID=$(basename \"${file}\" _R1.fastq.gz)\n    \n    REMAINING=$((TOTAL - COUNTER)) # Calculate remaining samples\n\n    # Display sample information with the counter\n    echo -e \"   Sample: ${ID}  [${COUNTER}/${TOTAL}; ${REMAINING} remaining]\n                R1: ${DIRECTORY}/${ID}_R1.fastq.gz\n                R2: ${DIRECTORY}/${ID}_R2.fastq.gz\"\n\n    # Run the profiling command\n    tb-profiler profile -1 ${DIRECTORY}/${ID}_R1.fastq.gz \\\n                        -2 ${DIRECTORY}/${ID}_R2.fastq.gz \\\n                        -t 4 -p ${ID} --txt\n        \n    COUNTER=$((COUNTER + 1)) # Increment the counter\ndone\n```\n:::\n\n\nYou can even combine the loop with the `if` statement:\n\n\n::: {.cell}\n\n```{.bash .cell-code}\nCOUNTER=0 # start the counter at zero\nfor file in ${DIRECTORY}/*R1.fastq.gz; do\n    ID=$(basename \"${file}\" _R1.fastq.gz)\n    # Calculate remaining samples\n    REMAINING=$((TOTAL - COUNTER))\n\n    # If argument to check that the TB_profile hasnt already been run:\n    if [[ ! -f ${TBPROF_DIR}/results/${ID}.results.txt ]]; then\n        # Display sample information with the counter\n        echo -e \"${cyan}\\tSample: ${ID}\\t\\t[$COUNTER/$TOTAL; $REMAINING remaining]\\n\\t\\tR1: ${DIRECTORY}/${ID}_R1.fastq.gz\\n\\t\\tR2: ${DIRECTORY}/${ID}_R2.fastq.gz\"\n        echo -e \"${nocolor}\"\n        # Run the profiling command\n        tb-profiler profile -1 ${DIRECTORY}/${ID}_R1.fastq.gz -2 ${DIRECTORY}/${ID}_R2.fastq.gz -t ${NTHREADS} -p ${ID} --txt\n        # Increment the counter\n        COUNTER=$((COUNTER + 1))\n    elif [[ -f ${TBPROF_DIR}/results/${ID}.results.txt ]]; then\n        echo -e \"${red}\\t${TBPROF_DIR}/results/${ID}.results.txt exists, skipping: ${ID}\\t\\t[$COUNTER/$TOTAL; $REMAINING remaining]\"\n        COUNTER=$((COUNTER + 1))\n    fi\ndone\n```\n:::\n\n\n---\n\n**[Part 2]() ⋘ Part 3 ⋙ [Part 4]()**",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}